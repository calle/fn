<!DOCTYPE html>
<html>
<head>
<title>Identilight</title>
</head>
<body>

  <div>
    <div id="question"></div>
    <div>
      <input type="text" id="answerText">
    </div>
    <div>
      <button id="submitButton">Submit (POST)</button>
      <button id="fakeSubmitButton">Submit (Fake Test)</button>
    </div>
    <div id="candidates"></div>
    <div id="debugging"></div>
  </div>

  <script type="text/coffeescript"> 

    middlewareUrl = 'http://middle.wideberg.com/question'
    questionsArray = []
    currentQuestionCode = '';

    $('#submitButton').click ->
        questionsArray.push getQuestionAnswerPair()
        submitAnswer()

    $('#fakeSubmitButton').click ->
        exampleResponse = JSON.parse '{"question":"eyecolor","candidates":[{"name":"Calle","url":"http://profile.ak.fbcdn.net/hprofile-ak-snc4/23128_525938623_7208_n.jpg"},{"name":"Thomas","url":"http://profile.ak.fbcdn.net/hprofile-ak-snc4/23128_525938623_7208_n.jpg"},{"name":"Erik","url":"http://profile.ak.fbcdn.net/hprofile-ak-snc4/23128_525938623_7208_n.jpg"},{"name":"Lina","url":"http://profile.ak.fbcdn.net/hprofile-ak-snc4/23128_525938623_7208_n.jpg"},{"name":"Johan","url":"http://profile.ak.fbcdn.net/hprofile-ak-snc4/23128_525938623_7208_n.jpg"}]}'
        processResponse exampleResponse

    submitAnswer = ->
        $.ajax {
            type: 'POST',
            url: middlewareUrl,
            dataType: 'json',
            data: getData(),
            success: processResponse
        }

    processResponse = (data) ->
        $('#debugging').text JSON.stringify data
        processQuestion data.question
        processCandidates data.candidates

    processQuestion = (questionCode) ->
        currentQuestionCode = questionCode
        $('#question').text questionCode # TODO

    processCandidates = (candidates) ->
        for c in candidates
            $('#candidates').append('<div class="candidate"><img src="' + c.url + '"><b>' + c.name + '</b></div>')

    getQuestionAnswerPair = ->
        pair = {}
        pair[currentQuestionCode] = $('#answerText').val()
        pair

    getData = ->
        questionsObject = {}
        questionsObject["questions"] = questionsArray
        questionsJSON = JSON.stringify questionsObject
        dataObject = {}
        dataObject["data"] = questionsJSON
        dataObject

    # initialize

    submitAnswer()
 
  </script>

  <script src="scripts/jquery.js"></script>
  <script src="scripts/coffee-script.js"></script>

</body>
</html>